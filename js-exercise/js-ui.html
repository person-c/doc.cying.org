<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <style>
      html {
        height: 3000px;
      }
      .selected {
        background: #0f0;
      }

      li {
        cursor: pointer;
      }

      body {
        height: 2000px;
        /* 在页面滚动后，工具提示也应该正常展示 */
      }

      .tooltip {
        position: fixed;
        z-index: 100;

        padding: 10px 20px;

        border: 1px solid #b3c9ce;
        border-radius: 4px;
        text-align: center;
        font: italic 14px/1.3 sans-serif;
        color: #333;
        background: #fff;
        box-shadow: 3px 3px 3px rgba(0, 0, 0, 0.3);
      }

      #house {
        margin-top: 50px;
        width: 400px;
        border: 1px solid brown;
      }

      #roof {
        width: 0;
        height: 0;
        border-left: 200px solid transparent;
        border-right: 200px solid transparent;
        border-bottom: 20px solid brown;
        margin-top: -20px;
      }

      p {
        text-align: justify;
        margin: 10px 3px;
      }

      .title {
        font-size: 25px;
      }

      .slider {
        border-radius: 5px;
        background: #e0e0e0;
        background: linear-gradient(left top, #e0e0e0, #eeeeee);
        width: 310px;
        height: 15px;
        margin: 5px;
      }

      .thumb {
        width: 10px;
        height: 25px;
        border-radius: 3px;
        position: relative;
        left: 10px;
        top: -5px;
        background: blue;
        cursor: pointer;
      }

      html,
      body {
        margin: 0;
        padding: 0;
      }

      #field {
        background: url(field.svg);
        width: 800px;
        height: 500px;
        float: left;
      }

      /* 英雄和球（可拖动） */

      .hero {
        background: url(https://js.cx/drag-heroes/heroes.png);
        width: 130px;
        height: 128px;
        float: left;
      }

      #hero1 {
        background-position: 0 0;
      }

      #hero2 {
        background-position: 0 -128px;
      }

      #hero3 {
        background-position: -120px 0;
      }

      #hero4 {
        background-position: -125px -128px;
      }

      #hero5 {
        background-position: -248px -128px;
      }

      #hero6 {
        background-position: -244px 0;
      }

      .draggable {
        cursor: pointer;
      }

      body,
      html {
        height: 100%;
        width: 100%;
        padding: 0;
        margin: 0;
      }

      #matrix {
        width: 400px;
        margin: auto;
        overflow: auto;
        text-align: justify;
      }

      #arrowTop {
        height: 9px;
        width: 14px;
        color: green;
        position: fixed;
        top: 10px;
        left: 10px;
        cursor: pointer;
      }

      #arrowTop::before {
        content: '▲';
      }
    </style>
  </head>
  <body>
    <p class="title">Select items</p>
    <hr />
    <ul id="ul">
      <li>Christopher Robin</li>
      <li>Winnie-the-Pooh</li>
      <li>Tigger</li>
      <li>Kanga</li>
      <li>Rabbit. Just rabbit.</li>
    </ul>

    <p class="title">slide bar</p>
    <hr />

    <div id="slider" class="slider">
      <div class="thumb"></div>
    </div>

    <p class="title">drag ball</p>
    <hr />
    <h2>将超级英雄放置在足球场周围。</h2>

    <p>
      超级英雄和球都是带有 "draggable" 类的元素。使它们真的可拖动（draggable）。
    </p>

    <p>
      重要：通过窗口限制拖动。如果可拖动的元素被拖到窗口的顶端或末端，则页面应该滚动以让我们进一步拖动它。
    </p>

    <p>
      如果你的屏幕足够大，能够把整个文档都显示出来 ——
      那么请缩小窗口以进行垂直滚动，以便对此进行测试。
    </p>

    <p>
      在此任务中，处理垂直滚动就够了。通常没有水平滚动，并且在需要时可以采用类似的方式进行处理。
    </p>

    <p>
      此外：英雄永远都不会离开页面。如果它们到达了文档的边缘，它们不会被拖动到文档外。
    </p>

    <div id="field"></div>

    <div class="hero draggable" id="hero1"></div>
    <div class="hero draggable" id="hero2"></div>
    <div class="hero draggable" id="hero3"></div>
    <div class="hero draggable" id="hero4"></div>
    <div class="hero draggable" id="hero5"></div>
    <div class="hero draggable" id="hero6"></div>

    <img
      src="https://en.js.cx/clipart/ball.svg"
      class="draggable"
      title="ball"
    />

    <div style="clear: both"></div>

    <p class="title">Hot key</p>
    <hr />
    <p>hotkey函数, 输入热键组合以及组合键按下时调用的函数，方便调用函数</p>

    <p class="title">up and down button</p>
    <hr />
    <div id="matrix">
      <script>
        for (let i = 0; i < 2000; i++) document.writeln(i);
      </script>
    </div>

    <p class="title">加载可视化图像</p>
    <hr />
    <p>Text and pictures are from https://wikipedia.org.</p>

    <h3>All images with <code>data-src</code> load when become visible.</h3>

    <h1>Solar system</h1>

    <p>
      The Solar System is the gravitationally bound system comprising the Sun
      and the objects that orbit it, either directly or indirectly. Of those
      objects that orbit the Sun directly, the largest eight are the planets,
      with the remainder being significantly smaller objects, such as dwarf
      planets and small Solar System bodies. Of the objects that orbit the Sun
      indirectly, the moons, two are larger than the smallest planet, Mercury.
    </p>

    <p>
      The Solar System formed 4.6 billion years ago from the gravitational
      collapse of a giant interstellar molecular cloud. The vast majority of the
      system's mass is in the Sun, with most of the remaining mass contained in
      Jupiter. The four smaller inner planets, Mercury, Venus, Earth and Mars,
      are terrestrial planets, being primarily composed of rock and metal. The
      four outer planets are giant planets, being substantially more massive
      than the terrestrials. The two largest, Jupiter and Saturn, are gas
      giants, being composed mainly of hydrogen and helium; the two outermost
      planets, Uranus and Neptune, are ice giants, being composed mostly of
      substances with relatively high melting points compared with hydrogen and
      helium, called volatiles, such as water, ammonia and methane. All planets
      have almost circular orbits that lie within a nearly flat disc called the
      ecliptic.
    </p>

    <figure>
      <img
        src="placeholder.svg"
        data-src="https://en.js.cx/clipart/solar/planets.jpg"
        width="640"
        height="360"
      />
    </figure>

    <h1>Sun</h1>

    <p>
      The Sun is the Solar System's star and by far its most massive component.
      Its large mass (332,900 Earth masses) produces temperatures and densities
      in its core high enough to sustain nuclear fusion of hydrogen into helium,
      making it a main-sequence star. This releases an enormous amount of
      energy, mostly radiated into space as electromagnetic radiation peaking in
      visible light.
    </p>

    <figure>
      <img
        src="placeholder.svg"
        data-src="https://en.js.cx/clipart/solar/sun.jpg"
        width="658"
        height="658"
      />
    </figure>

    <h1>Mercury</h1>

    <p>
      Mercury (0.4 AU from the Sun) is the closest planet to the Sun and the
      smallest planet in the Solar System (0.055 Earth masses). Mercury has no
      natural satellites; besides impact craters, its only known geological
      features are lobed ridges or rupes that were probably produced by a period
      of contraction early in its history.[67] Mercury's very tenuous atmosphere
      consists of atoms blasted off its surface by the solar wind.[68] Its
      relatively large iron core and thin mantle have not yet been adequately
      explained. Hypotheses include that its outer layers were stripped off by a
      giant impact; or, that it was prevented from fully accreting by the young
      Sun's energy.
    </p>

    <figure>
      <img
        src="placeholder.svg"
        data-src="https://en.js.cx/clipart/solar/mercury.jpg"
        width="390"
        height="390"
      />
    </figure>

    <h1>Venus</h1>

    <p>
      Venus (0.7 AU from the Sun) is close in size to Earth (0.815 Earth masses)
      and, like Earth, has a thick silicate mantle around an iron core, a
      substantial atmosphere, and evidence of internal geological activity. It
      is much drier than Earth, and its atmosphere is ninety times as dense.
      Venus has no natural satellites. It is the hottest planet, with surface
      temperatures over 400 °C (752°F), most likely due to the amount of
      greenhouse gases in the atmosphere. No definitive evidence of current
      geological activity has been detected on Venus, but it has no magnetic
      field that would prevent depletion of its substantial atmosphere, which
      suggests that its atmosphere is being replenished by volcanic eruptions.
    </p>

    <figure>
      <img
        src="placeholder.svg"
        data-src="https://en.js.cx/clipart/solar/venus.jpg"
        width="390"
        height="390"
      />
    </figure>

    <h1>Earth</h1>

    <p>
      Earth (1 AU from the Sun) is the largest and densest of the inner planets,
      the only one known to have current geological activity, and the only place
      where life is known to exist. Its liquid hydrosphere is unique among the
      terrestrial planets, and it is the only planet where plate tectonics has
      been observed. Earth's atmosphere is radically different from those of the
      other planets, having been altered by the presence of life to contain 21%
      free oxygen. It has one natural satellite, the Moon, the only large
      satellite of a terrestrial planet in the Solar System.
    </p>

    <figure>
      <img
        src="placeholder.svg"
        data-src="https://en.js.cx/clipart/solar/earth.jpg"
        width="390"
        height="390"
      />
    </figure>

    <h1>Mars</h1>

    <p>
      Mars (1.5 AU from the Sun) is smaller than Earth and Venus (0.107 Earth
      masses). It has an atmosphere of mostly carbon dioxide with a surface
      pressure of 6.1 millibars (roughly 0.6% of that of Earth). Its surface,
      peppered with vast volcanoes, such as Olympus Mons, and rift valleys, such
      as Valles Marineris, shows geological activity that may have persisted
      until as recently as 2 million years ago. Its red colour comes from iron
      oxide (rust) in its soil. Mars has two tiny natural satellites (Deimos and
      Phobos) thought to be captured asteroids.
    </p>

    <figure>
      <img
        src="placeholder.svg"
        data-src="https://en.js.cx/clipart/solar/mars.jpg"
        width="390"
        height="390"
      />
    </figure>

    <h1>Jupiter</h1>

    <p>
      Jupiter (5.2 AU), at 318 Earth masses, is 2.5 times the mass of all the
      other planets put together. It is composed largely of hydrogen and helium.
      Jupiter's strong internal heat creates semi-permanent features in its
      atmosphere, such as cloud bands and the Great Red Spot. Jupiter has 67
      known satellites. The four largest, Ganymede, Callisto, Io, and Europa,
      show similarities to the terrestrial planets, such as volcanism and
      internal heating. Ganymede, the largest satellite in the Solar System, is
      larger than Mercury.
    </p>

    <figure>
      <img
        src="placeholder.svg"
        data-src="https://en.js.cx/clipart/solar/jupiter.jpg"
        width="390"
        height="390"
      />
    </figure>

    <h1>Saturn</h1>
    <p>
      Saturn (9.5 AU), distinguished by its extensive ring system, has several
      similarities to Jupiter, such as its atmospheric composition and
      magnetosphere. Although Saturn has 60% of Jupiter's volume, it is less
      than a third as massive, at 95 Earth masses. Saturn is the only planet of
      the Solar System that is less dense than water. The rings of Saturn are
      made up of small ice and rock particles. Saturn has 62 confirmed
      satellites composed largely of ice. Two of these, Titan and Enceladus,
      show signs of geological activity. Titan, the second-largest moon in the
      Solar System, is larger than Mercury and the only satellite in the Solar
      System with a substantial atmosphere.
    </p>

    <figure>
      <img
        src="placeholder.svg"
        data-src="https://en.js.cx/clipart/solar/saturn.jpg"
        width="805"
        height="390"
      />
    </figure>

    <h1>Uranus</h1>
    <p>
      Uranus (19.2 AU), at 14 Earth masses, is the lightest of the outer
      planets. Uniquely among the planets, it orbits the Sun on its side; its
      axial tilt is over ninety degrees to the ecliptic. It has a much colder
      core than the other giant planets and radiates very little heat into
      space. Uranus has 27 known satellites, the largest ones being Titania,
      Oberon, Umbriel, Ariel, and Miranda.
    </p>

    <figure>
      <img
        src="placeholder.svg"
        data-src="https://en.js.cx/clipart/solar/uranus.jpg"
        width="390"
        height="390"
      />
    </figure>

    <h1>Neptune</h1>
    <p>
      Neptune (30.1 AU), though slightly smaller than Uranus, is more massive
      (equivalent to 17 Earths) and hence more dense. It radiates more internal
      heat, but not as much as Jupiter or Saturn. Neptune has 14 known
      satellites. The largest, Triton, is geologically active, with geysers of
      liquid nitrogen. Triton is the only large satellite with a retrograde
      orbit. Neptune is accompanied in its orbit by several minor planets,
      termed Neptune trojans, that are in 1:1 resonance with it.
    </p>

    <figure>
      <img
        src="placeholder.svg"
        data-src="https://en.js.cx/clipart/solar/neptune.jpg"
        width="390"
        height="390"
      />
    </figure>

    <div id="arrowTop" hidden></div>

    <p class="title">infinity page</p>
    <hr />
    <script>
      // select items
      ul.addEventListener('click', (e) => {
        if (e.target.tagName != 'LI') return false;

        e.ctrlKey || e.metaKey
          ? toggleSelect(e.target)
          : singleSelect(e.target);
      });

      // prevent unneeded selection of list elements on clicks
      ul.onmousedown = function () {
        return false;
      };

      function toggleSelect(li) {
        li.classList.toggle('selected');
      }

      function singleSelect(li) {
        let liSelected = ul.querySelectorAll('li');
        for (let elem of liSelected) {
          elem.classList.remove('selected');
        }
        li.classList.add('selected');
      }

      // slide bar
      let thumb = slider.querySelector('.thumb');
      thumb.addEventListener('mousedown', (e) => {
        e.preventDefault(); // prevent browser default behavior
        console.log(e);
        let shiftX = e.clientX - e.target.getBoundingClientRect().left; // mouse position to object left line

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        function onMouseMove(e) {
          let newLeft =
            e.clientX - shiftX - slider.getBoundingClientRect().left;
          let rightEdge = slider.offsetWidth - thumb.offsetWidth;
          newLeft = newLeft < 0 ? 0 : newLeft;
          newLeft = newLeft > rightEdge ? rightEdge : newLeft;

          thumb.style.left = newLeft + 'px';
        }
        function onMouseUp() {
          document.removeEventListener('mouseup', onMouseUp);
          document.removeEventListener('mousemove', onMouseMove);
        }
      });
      thumb.ondragstart = function () {
        return false;
      };
      // drag ball
      let isDragging = false;

      document.addEventListener('mousedown', function (event) {
        let dragElement = event.target.closest('.draggable');

        if (!dragElement) return;

        event.preventDefault();

        dragElement.ondragstart = function () {
          return false;
        };

        let coords, shiftX, shiftY;

        startDrag(dragElement, event.clientX, event.clientY);

        function onMouseUp(event) {
          finishDrag();
        }

        function onMouseMove(event) {
          moveAt(event.clientX, event.clientY);
        }

        // 在拖动开始时：
        //   记住初始的移位
        //   将元素设置为 position:fixed，并将此元素移动到作为 body 的直接子元素
        function startDrag(element, clientX, clientY) {
          if (isDragging) {
            return;
          }

          isDragging = true;

          document.addEventListener('mousemove', onMouseMove);
          element.addEventListener('mouseup', onMouseUp);

          shiftX = clientX - element.getBoundingClientRect().left;
          shiftY = clientY - element.getBoundingClientRect().top;

          element.style.position = 'fixed';

          moveAt(clientX, clientY);
        }

        // 在最后，转换到绝对（absolute）坐标，以将元素固定在文档中
        function finishDrag() {
          if (!isDragging) {
            return;
          }

          isDragging = false;

          dragElement.style.top =
            parseInt(dragElement.style.top) + window.pageYOffset + 'px';
          dragElement.style.position = 'absolute';

          document.removeEventListener('mousemove', onMouseMove);
          dragElement.removeEventListener('mouseup', onMouseUp);
        }

        function moveAt(clientX, clientY) {
          // 新的窗口相对坐标
          let newX = clientX - shiftX;
          let newY = clientY - shiftY;

          // 检查新坐标是否在底部窗口边缘以下
          let newBottom = newY + dragElement.offsetHeight; // new bottom

          // 在窗口边缘以下？让我们滚动此页面
          if (newBottom > document.documentElement.clientHeight) {
            // 文档末端的窗口相对坐标
            let docBottom =
              document.documentElement.getBoundingClientRect().bottom;

            // 将文档向下滚动 10px 有一个问题
            // 它可以滚动到文档末尾之后
            // Math.min(how much left to the end, 10)
            let scrollY = Math.min(docBottom - newBottom, 10);

            // 计算是不精确的，可能会有舍入误差导致页面向上滚动
            // 这是不应该出现，我们在这儿解决它
            if (scrollY < 0) scrollY = 0;

            window.scrollBy(0, scrollY);

            // 快速移动鼠标将指针移至文档末端的外面
            // 如果发生这种情况 ——
            //  使用最大的可能距离来限制 newY（就是文档末端到顶端的距离）
            newY = Math.min(
              newY,
              document.documentElement.clientHeight - dragElement.offsetHeight
            );
          }

          // 检查新坐标是否在顶部窗口边缘上方（类似的逻辑）
          if (newY < 0) {
            // scroll up
            let scrollY = Math.min(-newY, 10);
            if (scrollY < 0) scrollY = 0; // 检查精度损失

            window.scrollBy(0, -scrollY);
            // 快速移动鼠标可以使指针超出文档的顶端
            newY = Math.max(newY, 0); // newY 不得小于 0
          }

          // 将 newX 限制在窗口范围内
          // 这里没有滚动，所以它很简单
          if (newX < 0) newX = 0;
          if (
            newX >
            document.documentElement.clientWidth - dragElement.offsetWidth
          ) {
            newX =
              document.documentElement.clientWidth - dragElement.offsetWidth;
          }

          dragElement.style.left = newX + 'px';
          dragElement.style.top = newY + 'px';
        }
      });

      //hot key
      function hotKey(func, ...keys) {
        let pressed = new Set();
        document.addEventListener('keydown', (e) => {
          pressed.add(e.code);

          for (let key of keys) {
            while (!pressed.has(key)) return false;
          }

          pressed.clear();
          func();
        });

        document.addEventListener('keyup', (e) => pressed.delete(e.code));
      }

      hotKey(() => alert('Hello!'), 'KeyQ', 'KeyW');

      // up and down buttons
      arrowTop.onclick = function () {
        window.scrollTo(pageXOffset, 0);
      };

      window.addEventListener('scroll', () => {
        arrowTop.hidden = pageYOffset < document.documentElement.clientHeight;
      });

      // 加载可视化图像
      function isVisible(elem) {
        let coords = elem.getBoundingClientRect();

        let windowHeight = document.documentElement.clientHeight;

        let extendedTop = -windowHeight;
        let extendedBottom = 2 * windowHeight;

        // top visible || bottom visible
        let topVisible =
          coords.top > extendedTop && coords.top < extendedBottom;
        let bottomVisible =
          coords.bottom < extendedBottom && coords.bottom > extendedTop;

        return topVisible || bottomVisible;
      }

      function showVisible() {
        for (let img of document.querySelectorAll('img')) {
          let realSrc = img.dataset.src;
          if (!realSrc) continue;

          if (isVisible(img)) {
            // disable caching
            // this line should be removed in production code
            realSrc += '?nocache=' + Math.random();

            img.src = realSrc;

            img.dataset.src = '';
          }
        }
      }

      window.addEventListener('scroll', showVisible);
      showVisible();

      // infinite scrolling
      // function populate() {
      //   while (true) {
      //     let windowRelativeBottom =
      //       document.documentElement.getBoundingClientRect().bottom;
      //     if (
      //       windowRelativeBottom >
      //       document.documentElement.clientHeight + 100
      //     )
      //       break;
      //     document.body.insertAdjacentHTML(
      //       'beforeend',
      //       `<p>Date: ${new Date()}</p>`
      //     );
      //   }
      // }

      // window.addEventListener('scroll', populate);

      // populate(); // init document
    </script>
  </body>
</html>
