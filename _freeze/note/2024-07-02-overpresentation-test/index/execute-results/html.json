{
  "hash": "ef7aae1416b366dd00801957557e9e2e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"富集分析\"\ndate: \"2024-07-02\"\nformat:\n    html: \n      self-contained: false\n      grid: \n        margin-width: 350px\nexecute: \n  echo: true\ntoc: true\nreference-location: margin\ncitation-location: margin\n---\n\n\n\n# Hypergeometric distribution test\n\n假设共有4条通路分别为A, B, C, D. 其中A, B, C通路含有分别有10个基因，D通路有26个基因。4条通路， 即整个背景基因集总共的基因（去重）数目为26。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(2024)\nall_pathway <- list(\n  A = sample(letters, 10),\n  B = sample(letters, 10),\n  C = sample(letters, 12),\n  D = letters\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nall_pathway[[\"A\"]]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"b\" \"e\" \"m\" \"q\" \"x\" \"i\" \"z\" \"k\" \"p\" \"n\"\n```\n\n\n:::\n\n```{.r .cell-code}\n(m <- all_pathway[[\"A\"]] |> length()) # A通路基因数目\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 10\n```\n\n\n:::\n\n```{.r .cell-code}\n(n <- 26 - 10) # 非A通路基因数目\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 16\n```\n\n\n:::\n:::\n\n\n假设我们获得了差异基因gene, 共5个。\n\n::: {.cell}\n\n```{.r .cell-code}\ngene <- c(\"a\", \"b\", \"c\", \"e\", \"f\")\n\n# 属于A通路的差异基因数目 -1\n(q <- intersect(all_pathway[[\"A\"]], gene) |> length() - 1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1\n```\n\n\n:::\n\n```{.r .cell-code}\n(k <- length(gene)) # 差异基因数目\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 5\n```\n\n\n:::\n:::\n\n\n我们所做的检验是：在26个基因中，有10个是A通路的基因，现在我们在26个基因中不放回的抽取5个基因，这5个基因中有2个是属于A通路的基因。从概率上， 我们从26个中抽取5个，其中属于A通路的基因数目 > 2 - 1的概率是多少(如果p < 0.05, 则说明这是小概率事件，但是却发生了；则说明这条通路是过度呈现的, over representation)）。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressMessages(all_pathway <- easybio::list2dt(all_pathway))\npvalue <- phyper(q, m, n, k, lower.tail = FALSE) # 超几何分布检验\n\ny <- clusterProfiler::enricher(\n  gene,\n  TERM2GENE = all_pathway,\n  pAdjustMethod = \"BH\",\n  pvalueCutoff = 1,\n  qvalueCutoff = 1,\n  minGSSize = 0\n) # 用于富集分析的一个经典的R包，其背后的原理实际上也是超几何分布检验。\ndata.table::setDT(y@result)[]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       ID Description GeneRatio BgRatio    pvalue  p.adjust    qvalue    geneID\n   <char>      <char>    <char>  <char>     <num>     <num>     <num>    <char>\n1:      B           B       3/5   10/26 0.2738218 0.8214655 0.8214655     a/b/c\n2:      A           A       2/5   10/26 0.6569170 0.9853755 0.9853755       b/e\n3:      D           D       5/5   26/26 1.0000000 1.0000000 1.0000000 a/b/c/e/f\n   Count\n   <int>\n1:     3\n2:     2\n3:     5\n```\n\n\n:::\n:::\n\n\n从结果可以看到A通路的p值计算结果，两者是一致的。其中 $GeneRation = (q + 1)/k, BgRation = m / (m + n)$\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# A 通路的GeneRation 以及 BgRation\ny@result[.(\"A\"), pvalue, on = .(ID)] == pvalue\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\n(GeneRation <- paste0(q + 1, \"/\", k))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"2/5\"\n```\n\n\n:::\n\n```{.r .cell-code}\n(BgRation <- paste0(m, \"/\", m + n))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"10/26\"\n```\n\n\n:::\n:::\n\n\n# GSEA\n\n给定一个由包含 $N$ 个基因, 由高到低排序的基因列表 $L = [g_1, g_2,...,g_N]$. 考虑一个基因集 $S$，如果其所含基因在$L$中均匀排列，那么其与这个排序无关。定义$S$在这个rank中总的hit score为：\n\n$$ N_R = \\sum_{g_j \\in G}|g_j|^p $$\n\n沿rank从$1 \\rightarrow i \\rightarrow N$， 第$i$步：\n\n$P_{hit}(S, i) = \\sum_{j <= i, g_j \\in G}\\frac{|r_j|^p}{N_R}$\n\n$P_{miss}(S, i) = \\sum_{j <= i, g_j \\notin G}\\frac{1}{N - N_h}$\n\n富集分数（Enrichment score, ES)定义为 $P_{hit}(S, i) - P_{miss}(S, i)$与0偏离的最大值。\n\n**假设检验** 置换检验，对$L$或者表型进行置换得到$ES$的分布函数进行检验。",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}