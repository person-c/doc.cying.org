<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.339">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-09-24">

<title>Health statics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="html-report_files/libs/clipboard/clipboard.min.js"></script>
<script src="html-report_files/libs/quarto-html/quarto.js"></script>
<script src="html-report_files/libs/quarto-html/popper.min.js"></script>
<script src="html-report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="html-report_files/libs/quarto-html/anchor.min.js"></script>
<link href="html-report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="html-report_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="html-report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="html-report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="html-report_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  
  <script>
    (function () {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src  = "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js";
      document.getElementsByTagName("head")[0].appendChild(script);
    })();
  </script>


<link rel="stylesheet" href="../css/link.css">
<link rel="stylesheet" href="../css/font.css">
</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Health statics</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 24, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>

<div class="cell" data-hash="html-report_cache/html/unnamed-chunk-1_3aabb0ec79231be736af6223317ba4f7">
<style type="text/css">
body {
  font-size:16px;
  font-family: Palatino, palatino linotype, palatino lt std, latin modern roman, source-han-serif-sc, 'Noto Serif SC', 'source han serif sc', 'source han serif cn', 'source han serif tc', 'source han serif tw', 'source han serif', 'noto serif cjk sc', songti sc, microsoft yahei, serif
}

blockquote {
  font-size: 14px;
}

code {
  font-family: Consolas, Courier, courier new, stkaiti, kaiti, simkai, monospace
}

pre,
code {
  font-size: .95em
}
</style>
</div>
<section id="统计描述" class="level1">
<h1>统计描述</h1>
<p>首先了解数据的频数分布，选用合适的集中以及离散趋势描述数据。</p>
<section id="数值变量" class="level2">
<h2 class="anchored" data-anchor-id="数值变量">数值变量</h2>
<p>频数分布图形： range / n 取整数。</p>
<ul>
<li><p>正态分布数据选用算术均值，方差/标准差/变异系数描述其分布。</p>
<p>理论公式：<br>
计算公式：</p></li>
</ul>
<blockquote class="blockquote">
<p>标准差，变异系数是同单位的。变异系数用于不同尺度，均值相差较大的数据。 方差/标准差/变异系数的计算都依赖于均值的计算。</p>
</blockquote>
<ul>
<li><p>对数正态分布数据选用几何均值，全距/四分位数。</p>
<p>理论公式：<br>
计算公式：</p></li>
<li><p>任意其它分布选用中位数，全距/四分位数</p></li>
</ul>
</section>
<section id="分类变量" class="level2">
<h2 class="anchored" data-anchor-id="分类变量">分类变量</h2>
<p>分类变量数据主要依赖于各种相对数描述，包括proportion, rate, ration.其中rate主要涉及到时间的概念。</p>
<blockquote class="blockquote">
<p>数据的标准化法 直接化法，按总人口统一人口数。 间接法， 每组死亡人数与预期死亡人数之比互相比较。</p>
<p>动态数列 定基/环比，变化/增长（-1），平均发展速度，平均变化速度。</p>
</blockquote>
</section>
</section>
<section id="正态总体均值的置信区间以及假设检验" class="level1">
<h1>正态总体均值的置信区间以及假设检验</h1>
<p><strong>定理一</strong> 设<span class="math inline">\(X_1, X_2, ..., X_n\)</span>是来自正态总体<span class="math inline">\(N(\mu, \sigma^2)\)</span>的样本，<span class="math inline">\(\bar{X}\)</span>是样本均值，则有：</p>
<p><span class="math display">\[
\bar{X} \sim N(\mu, \sigma^2/n).
\]</span></p>
<p><strong>定理二</strong> 设<span class="math inline">\(X_1, X_2, ..., X_n\)</span>是来自正态总体<span class="math inline">\(N(\mu, \sigma^2)\)</span>的样本， <span class="math inline">\(\bar{X}, S^2\)</span>分别是样本均值和样本方差，则有</p>
<ol type="1">
<li><p><span class="math display">\[
\frac{(n-1)S^2}{\sigma^2} \sim \chi^2_{(n-1)}.
\]</span></p></li>
<li><p><span class="math inline">\(\bar{X}\)</span>与<span class="math inline">\(S^2\)</span>相互独立。</p></li>
</ol>
<p><strong>定理三</strong> 设<span class="math inline">\(X_1, X_2, ..., X_n\)</span>是来自正态总体<span class="math inline">\(N(\mu, \sigma^2)\)</span>的样本， <span class="math inline">\(\bar{X}, S^2\)</span>分别是样本均值和样本方差，则有</p>
<p><span class="math display">\[
\frac{\bar{X} - \mu}{S/\sqrt{n}} \sim t(n-1).
\]</span></p>
<p><strong>证</strong> 由定理一，定理二</p>
<p><span class="math display">\[\bar{X} \sim N(\mu, \sigma^2/n), \frac{(n-1)S^2}{\sigma^2} \sim \chi^2_{(n-1)},\]</span></p>
<p>且两者独立，由<span class="math inline">\(t\)</span>分布定义知</p>
<p><span class="math display">\[
  \frac{\bar{X} - \mu}{\sigma / \sqrt{n}} \Bigg/ \sqrt{\frac{(n-1)S^2}{\sigma^2(n-1)}} \sim t(n-1).
  \]</span></p>
<p>化简上式左边，即得<strong>定理三</strong>。</p>
<p><strong>定理四</strong> 设<span class="math inline">\(X_1, X_2, ...,X_{n}\)</span>与<span class="math inline">\(Y_1, Y_2, ..., Y_n\)</span>分别是来自正态总体<span class="math inline">\(N(\mu_1, \sigma_1^2)\)</span>和<span class="math inline">\(N(\mu_1, \sigma_2^2)\)</span>的样本，且这两个样本相互独立。设<span class="math inline">\(\bar{X}, \bar{Y}\)</span>分别是这两个样本的样本均值；<span class="math inline">\(S_1^2, S_2^2\)</span>分别是这两个样本的样本方差，则有</p>
<ol type="1">
<li><span class="math inline">\(\frac{S_1^2 / S_2^2}{\sigma_1 / \sigma_2} \sim F(n_1 - 1, n_2 - 1);\)</span></li>
<li>当<span class="math inline">\(\sigma_1^2 = \sigma_2^2 = \sigma^2\)</span>时，</li>
</ol>
<p><span class="math display">\[
  \frac{(\bar{X} - \bar{Y}) - (\mu_1 - \mu_2)}{S_w\sqrt{\frac{1}{n_1} + \frac{1}{n_2}}},
  \]</span></p>
<p>其中 <span class="math inline">\(S_w = \frac{(n_1 - 1)S_1^2 + (n_2 - 1)S_2^2}{n_1 + n_2 - 2}, S_w = \sqrt{S_w^2}.\)</span></p>
<section id="小于等于2个样本的情况" class="level2">
<h2 class="anchored" data-anchor-id="小于等于2个样本的情况">小于等于2个样本的情况</h2>
<section id="单样本---样本均值总体均值的比较" class="level3">
<h3 class="anchored" data-anchor-id="单样本---样本均值总体均值的比较">单样本 - 样本均值总体均值的比较。</h3>
<p><strong>理论公式</strong></p>
<p><span class="math display">\[
\frac{\bar{X} - \mu}{\sigma/\sqrt{n}} \sim N(0, 1).
\]</span></p>
<p>当总体为正态变量或依赖于中心极限定理时（CLT)，该公式成立。</p>
<blockquote class="blockquote">
<p>中心极限定理描述了在大样本情况下样本均值服从于正态分布这一事实。</p>
</blockquote>
<p><strong><span class="math inline">\(\sigma\)</span>未知时</strong></p>
<p><span class="math display">\[
\frac{\bar{X} - \mu}{S/\sqrt{n}} \sim t(n-1).
\]</span></p>
<p>当<span class="math inline">\(n \rightarrow \infty\)</span>, <span class="math inline">\(t\)</span>分布近似于正态分布，计算时可用<span class="math inline">\(z\)</span>分布替代<span class="math inline">\(t\)</span>分布。</p>
</section>
<section id="配对样本均值比较" class="level3">
<h3 class="anchored" data-anchor-id="配对样本均值比较">配对样本均值比较</h3>
<p><span class="math display">\[
t(\upsilon) = \frac{\mid\bar{d} - 0 \mid}{S_\bar{d}} = \frac{\bar{d}}{S_\bar{d}}, \upsilon = 对子数 - 1.
\]</span></p>
</section>
<section id="两独立样本比较" class="level3">
<h3 class="anchored" data-anchor-id="两独立样本比较">两独立样本比较</h3>
<p><strong>理论公式</strong></p>
<p><span class="math display">\[
  \frac{(\bar{X} - \bar{Y}) - (\mu_1 - \mu_2)}{\sqrt{(\frac{\sigma_1^2}{n_1} + \frac{\sigma_2^2}{n_2})}} \sim N(0, 1).
\]</span></p>
<p><strong>样本数<span class="math inline">\(n\)</span>足够大<span class="math inline">\((n_1 &gt; 100, n_2 &gt; 100)\)</span></strong></p>
<ol type="1">
<li><p>此时<span class="math inline">\(s_1^2 \approx \sigma_1^2, s_2^2 \approx \sigma_2^2.\)</span></p></li>
<li></li>
</ol>
<p><span class="math display">\[
  Z = \frac{\mid \bar{X_1} - \bar{X_2} \mid}{S_{\bar{X_1} - \bar{X_2}}}, S_{\bar{X_1} - \bar{X_2}} = \sqrt{S_1^2/n_1 + S_2^2/n_2}.
  \]</span></p>
<p><strong>方差齐<span class="math inline">\(\sigma_1 = \sigma_2\)</span></strong></p>
<p><span class="math display">\[
t = \frac{\mid \bar{X_1} - \bar{X_2} \mid}{S_{\bar{X_1} - \bar{X_2}}}, \upsilon = n_1 + n_2 - 2.
\]</span></p>
<p>式中两样本均数之差的标准误：<span class="math inline">\(S_{\bar{X_1} - \bar{X_2}} = \sqrt{S_c^2(\frac{1}{n_1} + \frac{2}{n_2})}.\)</span></p>
<p>其中合并标准差的平方： <span class="math inline">\(S_c^2 = \frac{S_1^2(n_1 - 1) + S_2^2(n_2 - 1)}{n_1 + n_2 - 2}\)</span></p>
<p><strong>方差不齐</strong></p>
<p><span class="math display">\[
t^\prime = \frac{\bar{X_1} - \bar{X_2}}{\sqrt{\frac{S_1^2}{n_1} + \frac{S_2^2}{n_2}}}
\]</span></p>
<p>通过Satterhwaite法，对自由度进行校正</p>
<p><span class="math display">\[
\upsilon = \frac{(S_{\bar{X_1}}^2  + S_{\bar{X_2}}^2)^2}{\frac{S_{\bar{X_1}}^4}{n1 - 1} + \frac{S_{\bar{X_2}}^4}{n_2 - 1}}
\]</span></p>
</section>
</section>
<section id="大于等于3个样本的情况" class="level2">
<h2 class="anchored" data-anchor-id="大于等于3个样本的情况">大于等于3个样本的情况</h2>
<p><strong>单因素方差分分析(one way ANOVA)</strong></p>
<p><span class="math display">\[
F = \frac{MS_{组间}}{MS_{组内}} = \frac{SS_{组间}/\upsilon_{组间}}{SS_{组内}/
\upsilon_{组内}}
\]</span></p>
<p><strong>随机区组设计地方差分析</strong></p>
<blockquote class="blockquote">
<p>分组以后再进行随机化，分组地原因在于不同地组别特征对于观测指标有影响。实际上这里有两个因素对观测结果有影响，所以方差分析时也有两个假设。</p>
</blockquote>
</section>
</section>
<section id="二项分布以及泊松分布总体的假设检验" class="level1">
<h1>二项分布以及泊松分布总体的假设检验</h1>
<p><strong>二项分布</strong></p>
<p><span class="math display">\[
S_p = \sqrt{p(1-p)/n}
\]</span></p>
<p><strong>泊松分布</strong></p>
<p><strong><span class="math inline">\(\lambda_0 &gt; 20\)</span></strong></p>
<p><span class="math display">\[
Z = \frac{X - \lambda_0}{\sqrt{\lambda_0}}
\]</span></p>
</section>
<section id="rc列联表的卡方检验" class="level1">
<h1>R*C列联表的卡方检验</h1>
<p><strong>理论公式</strong></p>
<p><span class="math display">\[
\chi^2 = \sum\frac{(O - E)^2}{E}
\]</span></p>
<p><strong>四格表，构成比检验，关联性（独立性）检验的计算公式</strong></p>
<p><span class="math display">\[
\chi^2 = n(\sum\frac{O^2}{n_{r}n_{c}} - 1)
\]</span></p>
<blockquote class="blockquote">
<p>卡方分布是正态总体的一种为连续性的变量，四格表资料的卡方值为不连续的值。 当四格表中有小于5的期望值时，进行Yate 的连续性校正公式 <span class="math display">\[
\chi^2 = \sum\frac{(\mid O - E \mid - 0.2)^2}{E}
\]</span> 若<span class="math inline">\(n \le 40\)</span> 则采用Fisher确切概率法。</p>
</blockquote>
<p><strong>配对设计四格表的计算公式</strong></p>
<p><span class="math display">\[
\chi^2 = \frac{(b- c)^2}{b + c}, \upsilon = 1
\]</span></p>
<p>当 <span class="math inline">\(b + c \le 40\)</span> 时， 采用校正公式</p>
<p><span class="math display">\[
\chi^2 = \frac{(\mid b - c \mid - 1)^2}{b + c}, \upsilon = 1
\]</span></p>
<p><strong>卡方拟合优度检验的计算公式</strong></p>
<p><span class="math display">\[
\chi^2 = \sum\frac{(O - E)^2}{E}
\]</span></p>
</section>
<section id="秩和检验" class="level1">
<h1>秩和检验</h1>
<p>用于总体分布未知的数值变量以及有序的R*C列联表的检验。</p>
<section id="数值变量配对检验" class="level2">
<h2 class="anchored" data-anchor-id="数值变量配对检验">数值变量配对检验</h2>
<p><strong><span class="math inline">\(n \le 50\)</span></strong> 查表</p>
<p><strong><span class="math inline">\(n \ge 50\)</span></strong> 正态近似</p>
<p><span class="math display">\[
Z = \frac{\mid T - n(n + 1)/4  \mid - 0.5}{\sqrt{n(n+1)(2n+1)/24 - \frac{\sum(t_j^3 - t_j)}{48}}}
\]</span></p>
<p>当相同差值数较多时（不包括差值为0的值)，校正式</p>
<p><span class="math display">\[
Z = \frac{\mid T - n(n + 1)/4  \mid - 0.5}{\sqrt{n(n+1)(2n+1)/24}}
\]</span></p>
<p>其中<span class="math inline">\(t_j\)</span>是第<span class="math inline">\(j\)</span>个相同差值的个数。</p>
</section>
<section id="两个样本的检验" class="level2">
<h2 class="anchored" data-anchor-id="两个样本的检验">两个样本的检验</h2>
<p><strong><span class="math inline">\(n \le 50\)</span></strong> 查表。</p>
<p><strong><span class="math inline">\(n_1\)</span>或<span class="math inline">\(n_2 - n_1\)</span>超出表的范围</strong>正态近似</p>
<p><span class="math display">\[
Z = \frac{\mid T - n_1(N+1)/2 \mid - 0.5}{n_{1}n_{2}(N+1)/12}
\]</span></p>
<p>相同秩次过多时，采用校正式。</p>
<p><span class="math display">\[
Z_c = Z\sqrt{C},
\]</span></p>
<p>其中<span class="math inline">\(C = 1 - \sum(t_j^3 - t_j) / (N^3 - N).\)</span></p>
</section>
<section id="大于两个样本的检验" class="level2">
<h2 class="anchored" data-anchor-id="大于两个样本的检验">大于两个样本的检验</h2>
<p><strong>单向有序分类变量多个变量或者多个数值变量的检验</strong></p>
<p><span class="math display">\[
H =\frac{12}{N(N + 1)}(\sum\frac{R_i^2}{n_i}) - 3(N+1).
\]</span></p>
<p>相同秩次过多时，采用校正式</p>
<p><span class="math display">\[
H_c = H/C,
\]</span></p>
<p>其中<span class="math inline">\(C = 1 - \sum(t_j^3 - t_j) / (N^3 - N).\)</span></p>
<p><strong>随机区组的Friedman秩和检验</strong></p>
<p><span class="math display">\[
M = \frac{\sum_{j=1}^{a}n(\bar{R}_j - \bar{R})^2}{\sum_{j=1}^{a}\sum_{i=1}^{n}(R_{ij} - \bar{R})^2 / n(a-1)}
\]</span></p>
<p>当相同秩过多时可以进行校正，校正系数为</p>
<p><span class="math display">\[
C = 1 - \sum_{j=1}^{a}\sum_{p=1}^{l_i}(t_{jp}^3 - t_{jp})/[na(a^2 -1 )]
\]</span></p>
<p><span class="math display">\[
M_c = M/C
\]</span></p>
</section>
</section>
<section id="总结" class="level1">
<h1>总结</h1>
<div class="cell" data-hash="html-report_cache/html/unnamed-chunk-2_a799a56b9a02b9b3e8928cbf65661ff8">
<div class="cell-output-display">
<p><img src="img/hypothesis-test01.svg" class="img-fluid"></p>
</div>
</div>

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" data-line-spacing="2" role="list">
<div id="ref-ggplot2" class="csl-entry" role="listitem">
<div class="csl-left-margin">1. </div><div class="csl-right-inline">Wickham, H. <em><a href="https://ggplot2.tidyverse.org">ggplot2: Elegant graphics for data analysis</a></em>. (Springer-Verlag New York, 2016).</div>
</div>
<div id="ref-r-base" class="csl-entry" role="listitem">
<div class="csl-left-margin">2. </div><div class="csl-right-inline">R Core Team. <em><a href="https://www.R-project.org/">R: A language and environment for statistical computing</a></em>. (R Foundation for Statistical Computing, 2022).</div>
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        return container.innerHTML
      } else {
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        console.log("RESIZE");
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>